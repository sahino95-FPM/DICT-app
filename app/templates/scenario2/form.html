{% extends "layouts/base.html" %}

{% block title %}Mod√®le 2 - Analyse consolid√©e{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
    <a href="{{ url_for('main.dashboard') }}">Dashboard</a>
    <span class="separator">‚Ä∫</span>
    <a href="{{ url_for('main.scenarios_list') }}">Mod√®les</a>
    <span class="separator">‚Ä∫</span>
    <span class="current">Mod√®le 2</span>
</nav>
{% endblock %}

{% block content %}
<div class="scenario-form-page">
    <h2 class="page-title">Mod√®le 2: Analyse consolid√©e par dossier et structure</h2>
    <p class="page-description">
        Obtenez une vue consolid√©e des montants ex√©cut√©s regroup√©s par dossier (num_pec) et structure ex√©cutante,
        avec informations b√©n√©ficiaire, type de transaction et origine des donn√©es (ACTE/RUB).
    </p>

    <form method="POST" action="{{ url_for('scenario2.results') }}" class="form-container">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- P√©riode de soins -->
        <div class="form-section">
            <h3 class="form-section-title">üìÖ P√©riode de soins</h3>
            <p class="form-help">D√©limite la plage temporelle des actes √† inclure</p>

            <div class="form-row">
                <div class="form-group">
                    <label for="date_debut" class="required">Date de d√©but</label>
                    <input type="date" id="date_debut" name="date_debut" class="form-control"
                           value="{{ defaults.date_debut }}" required>
                </div>

                <div class="form-group">
                    <label for="date_fin" class="required">Date de fin</label>
                    <input type="date" id="date_fin" name="date_fin" class="form-control"
                           value="{{ defaults.date_fin }}" required>
                </div>
            </div>
        </div>

        <!-- Plage de montants -->
        <div class="form-section">
            <h3 class="form-section-title">üí∞ Plage de montants</h3>
            <p class="form-help">Filtre sur le montant des lignes √©l√©mentaires (FCFA)</p>

            <div class="form-row">
                <div class="form-group">
                    <label for="montant_min">Montant minimum</label>
                    <input type="number" id="montant_min" name="montant_min" class="form-control"
                           value="{{ defaults.montant_min }}" min="0" step="100">
                </div>

                <div class="form-group">
                    <label for="montant_max">Montant maximum</label>
                    <input type="number" id="montant_max" name="montant_max" class="form-control"
                           value="{{ defaults.montant_max }}" min="0" step="100">
                </div>
            </div>
        </div>

        <!-- Source des donn√©es -->
        <div class="form-section">
            <h3 class="form-section-title">üì¶ Source des donn√©es</h3>
            <p class="form-help">S√©lectionnez au moins une source de donn√©es</p>

            <div class="form-checkboxes">
                <div class="form-checkbox">
                    <input type="checkbox" id="include_acte" name="include_acte"
                           {% if defaults.include_acte %}checked{% endif %}>
                    <label for="include_acte">ACTE (list_acte_acte_trans)</label>
                </div>

                <div class="form-checkbox">
                    <input type="checkbox" id="include_rub" name="include_rub"
                           {% if defaults.include_rub %}checked{% endif %}>
                    <label for="include_rub">RUB (list_rub_hosp_acte_trans)</label>
                </div>
            </div>
        </div>

        <!-- Filtres b√©n√©ficiaire -->
        <div class="form-section">
            <h3 class="form-section-title">üë§ Filtres b√©n√©ficiaire</h3>
            <p class="form-help">Recherche par informations b√©n√©ficiaire (optionnel)</p>

            <div class="form-row">
                <div class="form-group">
                    <label for="num_bnf">Num√©ro b√©n√©ficiaire</label>
                    <input type="text" id="num_bnf" name="num_bnf" class="form-control"
                           value="{{ defaults.num_bnf }}" placeholder="Ex: 90741">
                </div>

                <div class="form-group">
                    <label for="nom_prenom">Nom & Pr√©nom</label>
                    <input type="text" id="nom_prenom" name="nom_prenom" class="form-control"
                           value="{{ defaults.nom_prenom }}" placeholder="Ex: SAHIN">
                </div>
            </div>

            <div class="form-group">
                <label for="num_pec">Num√©ro de dossier (PEC)</label>
                <input type="text" id="num_pec" name="num_pec" class="form-control"
                       value="{{ defaults.num_pec }}" placeholder="Ex: 2025/001234">
            </div>
        </div>

        <!-- Structures -->
        <div class="form-section">
            <h3 class="form-section-title">üè• Structures ex√©cutantes</h3>
            <p class="form-help">S√©lectionnez une ou plusieurs structures (optionnel)</p>

            <div class="form-group">
                <label for="id_structures">Structures</label>
                <select id="id_structures" name="id_structures" class="form-control" multiple size="6">
                    <option value="">-- Toutes les structures --</option>
                    {% for structure in structures %}
                    <option value="{{ structure.id_structure }}"
                            {% if structure.id_structure|string in defaults.id_structures %}selected{% endif %}>
                        {{ structure.nom_structure }}
                    </option>
                    {% endfor %}
                </select>
                <span class="form-help-inline">Maintenez Ctrl (Windows) ou Cmd (Mac) pour s√©lectionner plusieurs structures</span>
            </div>
        </div>

        <!-- Colonnes d'affichage -->
        <div class="form-section">
            <h3 class="form-section-title">üìä Colonnes d'affichage</h3>
            <p class="form-help">Choisissez les colonnes √† afficher dans les r√©sultats</p>

            <div class="form-checkboxes">
                <div class="form-checkbox">
                    <input type="checkbox" id="show_beneficiaire" name="show_beneficiaire"
                           {% if defaults.show_beneficiaire %}checked{% endif %}>
                    <label for="show_beneficiaire">Informations b√©n√©ficiaire</label>
                </div>

                <div class="form-checkbox">
                    <input type="checkbox" id="show_telephone" name="show_telephone"
                           {% if defaults.show_telephone %}checked{% endif %}>
                    <label for="show_telephone">T√©l√©phone</label>
                </div>

                <div class="form-checkbox">
                    <input type="checkbox" id="show_sexe" name="show_sexe"
                           {% if defaults.show_sexe %}checked{% endif %}>
                    <label for="show_sexe">Sexe</label>
                </div>

                <div class="form-checkbox">
                    <input type="checkbox" id="show_date_naissance" name="show_date_naissance"
                           {% if defaults.show_date_naissance %}checked{% endif %}>
                    <label for="show_date_naissance">Date de naissance</label>
                </div>

                <div class="form-checkbox">
                    <input type="checkbox" id="show_type_trans" name="show_type_trans"
                           {% if defaults.show_type_trans %}checked{% endif %}>
                    <label for="show_type_trans">Type de transaction</label>
                </div>

                <div class="form-checkbox">
                    <input type="checkbox" id="show_nb_lignes" name="show_nb_lignes"
                           {% if defaults.show_nb_lignes %}checked{% endif %}>
                    <label for="show_nb_lignes">Nombre de lignes</label>
                </div>
            </div>
        </div>

        <!-- Tri des r√©sultats -->
        <div class="form-section">
            <h3 class="form-section-title">‚ÜïÔ∏è Tri des r√©sultats</h3>

            <div class="form-row">
                <div class="form-group">
                    <label for="sort_by">Trier par</label>
                    <select id="sort_by" name="sort_by" class="form-control">
                        <option value="num_pec" {% if defaults.sort_by == 'num_pec' %}selected{% endif %}>
                            Num√©ro PEC
                        </option>
                        <option value="nom_structure" {% if defaults.sort_by == 'nom_structure' %}selected{% endif %}>
                            Nom structure
                        </option>
                        <option value="date_execution" {% if defaults.sort_by == 'date_execution' %}selected{% endif %}>
                            Date ex√©cution
                        </option>
                        <option value="montant_total" {% if defaults.sort_by == 'montant_total' %}selected{% endif %}>
                            Montant total
                        </option>
                        <option value="nb_lignes" {% if defaults.sort_by == 'nb_lignes' %}selected{% endif %}>
                            Nombre de lignes
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sort_order">Ordre</label>
                    <select id="sort_order" name="sort_order" class="form-control">
                        <option value="ASC" {% if defaults.sort_order == 'ASC' %}selected{% endif %}>
                            Croissant (A ‚Üí Z)
                        </option>
                        <option value="DESC" {% if defaults.sort_order == 'DESC' %}selected{% endif %}>
                            D√©croissant (Z ‚Üí A)
                        </option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Options avanc√©es -->
        <div class="form-section">
            <h3 class="form-section-title">‚öôÔ∏è Options avanc√©es</h3>

            <div class="form-checkboxes">
                <div class="form-checkbox">
                    <input type="checkbox" id="mask_phone" name="mask_phone"
                           {% if defaults.mask_phone %}checked{% endif %}>
                    <label for="mask_phone">üîí Masquer les num√©ros de t√©l√©phone (XXXXX1234)</label>
                </div>

                <div class="form-checkbox">
                    <input type="checkbox" id="show_details" name="show_details"
                           {% if defaults.show_details %}checked{% endif %}>
                    <label for="show_details">üßÆ Afficher le d√©tail des lignes</label>
                </div>

                <div class="form-checkbox">
                    <input type="checkbox" id="show_sql" name="show_sql"
                           {% if defaults.show_sql %}checked{% endif %}>
                    <label for="show_sql">üßë‚Äçüíª Afficher la requ√™te SQL g√©n√©r√©e</label>
                </div>
            </div>

            <div class="form-group">
                <label for="limit">‚è±Ô∏è Limiter le nombre de r√©sultats</label>
                <input type="number" id="limit" name="limit" class="form-control"
                       value="{{ defaults.limit }}" min="50" max="50000" step="50">
                <span class="form-help-inline">Entre 50 et 50 000 r√©sultats</span>
            </div>
        </div>

        <!-- Boutons d'action -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">
                üîç Ex√©cuter la recherche
            </button>
            <button type="reset" class="btn btn-secondary">
                üîÑ R√©initialiser
            </button>
        </div>
    </form>
</div>
{% endblock %}
