{% extends "layouts/base.html" %}

{% block title %}R√©sultats - Mod√®le 2{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
    <a href="{{ url_for('main.dashboard') }}">Dashboard</a>
    <span class="separator">‚Ä∫</span>
    <a href="{{ url_for('main.scenarios_list') }}">Mod√®les</a>
    <span class="separator">‚Ä∫</span>
    <a href="{{ url_for('scenario2.form') }}">Mod√®le 2</a>
    <span class="separator">‚Ä∫</span>
    <span class="current">R√©sultats</span>
</nav>
{% endblock %}

{% block content %}
<div class="results-page">
    <h2 class="page-title">R√©sultats - Analyse consolid√©e</h2>

    <!-- Bandeau de contexte -->
    <div class="context-banner">
        <div class="context-item">
            <strong>Num√©ro PEC:</strong> <span class="num-pec-highlight">{{ filters.num_pec }}</span>
        </div>
        <div class="context-item">
            <strong>Sources:</strong> ACTE, HOSPI
        </div>
        <div class="context-item">
            <strong>R√©sultats:</strong> {{ pagination.total_count|format_number }}
        </div>
    </div>

    <!-- M√©triques globales -->
    <div class="metrics-cards">
        <div class="metric-card">
            <div class="metric-value">{{ metrics.total_dossiers|format_number }}</div>
            <div class="metric-label">Dossiers (PEC)</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ metrics.total_beneficiaires|format_number }}</div>
            <div class="metric-label">B√©n√©ficiaires</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ metrics.total_lignes|format_number }}</div>
            <div class="metric-label">Lignes trait√©es</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ metrics.montant_total|format_currency }}</div>
            <div class="metric-label">Montant total</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ metrics.montant_moyen_dossier|format_currency }}</div>
            <div class="metric-label">Montant moyen/dossier</div>
        </div>
    </div>

    <!-- Actions -->
    <div class="actions-bar">
        <div class="actions-left">
            <a href="{{ url_for('scenario2.form') }}" class="btn btn-secondary">
                ‚Üê Affiner les filtres
            </a>
        </div>
        <div class="actions-right">
            <span class="export-label">Exporter:</span>
            <a href="{{ url_for('exports.export_scenario2', format='csv') }}" class="btn btn-sm btn-success">
                üìÑ CSV
            </a>
            <a href="{{ url_for('exports.export_scenario2', format='xlsx') }}" class="btn btn-sm btn-success">
                üìä XLSX
            </a>
            <a href="{{ url_for('exports.export_scenario2', format='pdf') }}" class="btn btn-sm btn-success">
                üìï PDF
            </a>
            <a href="{{ url_for('exports.export_scenario2', format='word') }}" class="btn btn-sm btn-success">
                üìò WORD
            </a>
        </div>
    </div>

    <!-- Requ√™te SQL (si demand√©e) -->
    {% if sql_query %}
    <div class="sql-display">
        <h3 class="section-title">üßë‚Äçüíª Requ√™te SQL g√©n√©r√©e</h3>
        <pre class="sql-code">{{ sql_query }}</pre>
    </div>
    {% endif %}

    <!-- Tableau des r√©sultats -->
    {% if results %}
    <div class="table-container">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Structure ex√©cutante</th>
                    <th>Num√©ro PEC</th>
                    <th>Date ex√©cution</th>
                    <th>Libell√© Acte/Rubrique</th>
                    <th>Source</th>
                    {% if filters.show_beneficiaire %}
                    <th>Num. b√©n√©ficiaire</th>
                    <th>Nom & Pr√©nom</th>
                    {% endif %}
                    {% if filters.show_telephone %}
                    <th>T√©l√©phone</th>
                    {% endif %}
                    {% if filters.show_sexe %}
                    <th>Sexe</th>
                    {% endif %}
                    {% if filters.show_date_naissance %}
                    <th>Date naissance</th>
                    {% endif %}
                    {% if filters.show_type_trans %}
                    <th>Type transaction</th>
                    {% endif %}
                    {% if filters.show_nb_lignes %}
                    <th class="text-right">Nb/Co</th>
                    {% endif %}
                    <th class="text-right">Montant group√©</th>
                    <th class="text-right">Total cumul√© PEC</th>
                    <th class="text-center">Facture</th>
                </tr>
            </thead>
            <tbody>
                {% for row in results %}
                <tr>
                    <td>{{ row.nom_structure or 'N/A' }}</td>
                    <td class="font-weight-bold">{{ row.num_pec or 'N/A' }}</td>
                    <td>{{ row.premiere_date_execution|format_date('%d-%m-%Y %H:%M:%S') }}</td>
                    <td>{{ row.libelle_acte or 'N/A' }}</td>
                    <td>
                        <span class="badge badge-{{ 'primary' if row.source_ligne == 'ACTE' else 'info' }}">
                            {{ row.source_ligne or 'N/A' }}
                        </span>
                    </td>
                    {% if filters.show_beneficiaire %}
                    <td>{{ row.num_bnf or 'N/A' }}</td>
                    <td>{{ row.nom_prenom or 'N/A' }}</td>
                    {% endif %}
                    {% if filters.show_telephone %}
                    <td>{{ row.telephone or 'N/A' }}</td>
                    {% endif %}
                    {% if filters.show_sexe %}
                    <td>{{ row.sexe or 'N/A' }}</td>
                    {% endif %}
                    {% if filters.show_date_naissance %}
                    <td>{{ row.date_naissance|format_date('%d-%m-%Y %H:%M:%S') if row.date_naissance else 'N/A' }}</td>
                    {% endif %}
                    {% if filters.show_type_trans %}
                    <td>{{ row.libelle_type_trans or 'N/A' }}</td>
                    {% endif %}
                    {% if filters.show_nb_lignes %}
                    <td class="text-right">{{ row.nb_lignes|format_number }}</td>
                    {% endif %}
                    <td class="text-right font-weight-bold">{{ row.montant_execute_total|format_currency }}</td>
                    <td class="text-right text-primary font-weight-bold">
                        {{ row.montant_group_numpec|format_currency }}
                    </td>
                    <td class="text-center">
                        {% if row.num_pec %}
                        <a href="{{ url_for('scenario2.facture', num_pec=row.num_pec) }}"
                           class="btn-facture"
                           title="Voir la facture d√©taill√©e"
                           target="_blank"
                           rel="noopener noreferrer">
                            üìÑ FACTURE
                        </a>
                        {% else %}
                        <span class="text-muted">N/A</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% include 'partials/pagination.html' %}

    {% else %}
    <div class="empty-state">
        <p>Aucun r√©sultat trouv√© pour ces crit√®res de recherche</p>
        <a href="{{ url_for('scenario2.form') }}" class="btn btn-primary">Modifier les filtres</a>
    </div>
    {% endif %}

    <!-- Sauvegarde de l'analyse -->
    <div class="section">
        <h3 class="section-title">üíæ Enregistrer cette analyse</h3>
        <form method="POST" action="{{ url_for('scenario2.save_analysis') }}" class="save-analysis-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="form-row">
                <div class="form-group">
                    <label for="nom_utilisateur">Nom de l'utilisateur</label>
                    <input type="text" id="nom_utilisateur" name="nom_utilisateur"
                           class="form-control" value="Admin" required>
                </div>

                <div class="form-group">
                    <label for="intitule">Intitul√© de l'analyse</label>
                    <input type="text" id="intitule" name="intitule" class="form-control"
                           placeholder="Ex: Analyse consolid√©e dossiers janvier 2025" required>
                </div>
            </div>

            <div class="form-group">
                <label for="motif">Motif / Commentaire</label>
                <textarea id="motif" name="motif" class="form-control" rows="3"
                          placeholder="D√©crivez l'objectif de cette analyse..."></textarea>
            </div>

            <button type="submit" class="btn btn-primary">
                üíæ Enregistrer l'analyse
            </button>
        </form>
    </div>
</div>

<style>
/* Styles sp√©cifiques pour le sc√©nario 2 */

/* Mise en √©vidence du num√©ro PEC */
.num-pec-highlight {
    color: #007bff;
    font-weight: 700;
    font-size: 1.15rem;
    padding: 2px 8px;
    background: #e7f3ff;
    border-radius: 4px;
}

/* Conteneur de tableau avec d√©filement horizontal */
.table-container {
    width: 100%;
    overflow-x: auto;
    overflow-y: visible;
    margin-bottom: 1.5rem;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    background: white;
}

/* Table avec largeur minimale pour forcer le d√©filement si n√©cessaire */
.table-container table {
    min-width: 1600px;
    margin-bottom: 0;
}

/* Fixer les en-t√™tes lors du d√©filement */
.table-container thead th {
    position: sticky;
    top: 0;
    background-color: #28a745;
    color: white;
    z-index: 10;
    white-space: nowrap;
    padding: 12px 8px;
    font-size: 0.9rem;
    border-bottom: 2px solid #1e7e34;
}

/* Cellules du tableau */
.table-container td {
    white-space: nowrap;
    padding: 10px 8px;
    font-size: 0.9rem;
}

/* Colonnes importantes en gras */
.table-container td.font-weight-bold {
    font-weight: 600;
}

.badge {
    display: inline-block;
    padding: 0.25em 0.6em;
    font-size: 85%;
    font-weight: 600;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
}

.badge-primary {
    background-color: #007bff;
    color: white;
}

.badge-info {
    background-color: #17a2b8;
    color: white;
}

.text-primary {
    color: #007bff !important;
}

.text-right {
    text-align: right;
}

.table-hover tbody tr:hover {
    background-color: #f5f5f5;
}

/* Barre de d√©filement personnalis√©e */
.table-container::-webkit-scrollbar {
    height: 12px;
}

.table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.table-container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

.table-container::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Bouton FACTURE */
.btn-facture {
    display: inline-block;
    padding: 6px 12px;
    background-color: #28a745;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
    white-space: nowrap;
}

.btn-facture:hover {
    background-color: #218838;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    color: white;
    text-decoration: none;
}

.btn-facture:active {
    transform: translateY(0);
    box-shadow: none;
}

.text-muted {
    color: #6c757d;
    font-style: italic;
}
</style>
{% endblock %}
